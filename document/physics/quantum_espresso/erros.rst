ErrorとSTOPについて
=========================================

vc-relaxのscf計算をQuantumEspressoにやらせていると、その圧力範囲が **0Gpa~1000Gpa** という広範な範囲に成ったときによくエラーが起きる。あるいは、エラーは発生しないものの計算が途中で終了してしまったりする。その種類と、アドホック的ではあるが解決策をまとめておこうと思う。

エラーについて
-----------------------------------

1. S-matrixが正定値ではない

    .. code-block:: fortran

      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
      Error in routine cdiaghg
      (30): S matrix not positive definite
      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    原子間距離がrelaxやvc-relaxなどの **構造最適化で求まるものよりも近すぎる** （つまりは初期条件のセルパラメータが小さすぎる）ときや、 **conduction band** が多すぎるときなどに発生しやすい。
    - ecutwfcとecutrhoを増やす
    - relaxやvc-relaxで得られた構造を使う
    - nbndを減らす

    この３つ目の方法において、たとえばNaHのvc-relax計算では2d3の圧力をかけたとき、mixing_beta=0.01(0.2でもよかった)、a=3.0(3.78ではエラーを吐いた)、ecutwfc=60、ecutrho=400、nbnd=10（20でもよかった）でようやくエラーを吐かずに計算を終了するようになった。しかし、これらの条件下で圧力を1d4とすると、エラーを吐いた。

2. Fermiエネルギーが変

#. FFTを実行するためのallocatedなメモリーが足りない

    .. code-block:: fortran

        Error in routine scale_h(1): 21122
        Not enough space allocated for radial FFT: try restarting with a larger cell_factor

    設定された圧力値に対して初期条件に設定されたセルパラメータが小さすぎて、セルの膨らみによって基底計算をするためのallocatedメモリーが足りなくなる。初期値のセルパラメータを大きくして再計算する。


注意について
------------------------------------

1. IEEE_DENORMAL
    IEEE規格のfloat計算で精度の保証された正規数ではない数値も使って計算しているという報告。計算をSTOPすることは滅多にないし、計算結果自体にはそれほど大きな問題は与えないのであまり気にしなくていい。

2. UNDERFLOW_IEEE_DENORMAL
    IEE規格のfloat計算で精度の保証された正規数ではない数値を使って計算しているという報告。この場合はUNDERFLOWが発生している。これは、設定された圧力値に対してセルパラメータの初期条件が大きすぎる場合によく発生する問題。ログにこれが残っている場合は、 **セルパラメータをより小さめの値にうまく調節** するとよい。
